// =============================================================================
// ACQUIRELY - Complete Prisma Schema
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// AUTHENTICATION & USER MANAGEMENT
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  phone         String?
  
  // Subscription
  plan                 String    @default("free")
  planStatus           String    @default("active")
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  subscriptionStatus   String?
  currentPeriodEnd     DateTime?
  planExpiresAt        DateTime?
  
  // Pilot Program
  pilotUser         Boolean   @default(false)
  pilotGrantedBy    String?
  pilotGrantedAt    DateTime?
  pilotExpiresAt    DateTime?
  pilotNotes        String?
  
  // Profile
  title         String?
  company       String?
  location      String?
  bio           String?
  
  // Preferences
  preferences   Json?
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  memberships   Membership[]
  deals         Deal[]
  clients       Client[]
  exports       Export[]
  activities    Activity[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// =============================================================================
// ORGANIZATION & TEAM MANAGEMENT
// =============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  type        String   @default("brokerage")
  
  // Subscription
  plan              String    @default("free")
  planStatus        String    @default("active")
  stripeCustomerId  String?   @unique
  stripeSubscriptionId String?
  planExpiresAt     DateTime?
  maxUsers          Int       @default(1)
  
  // Branding
  logoUrl       String?
  primaryColor  String?
  secondaryColor String?
  website       String?
  
  // Contact
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?   @default("US")
  
  // Settings
  settings      Json?
  
  // Relations
  members       Membership[]
  deals         Deal[]
  clients       Client[]
  exports       Export[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("organizations")
}

model Membership {
  id             String   @id @default(cuid())
  role           String
  
  canCreateDeals    Boolean @default(true)
  canDeleteDeals    Boolean @default(false)
  canExport         Boolean @default(true)
  canManageClients  Boolean @default(false)
  canManageTeam     Boolean @default(false)
  canManageBilling  Boolean @default(false)
  
  userId         String
  organizationId String
  
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  invitedBy      String?
  invitedAt      DateTime?
  acceptedAt     DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("memberships")
}

// =============================================================================
// CLIENT MANAGEMENT
// =============================================================================

model Client {
  id            String   @id @default(cuid())
  
  name          String
  email         String?
  phone         String?
  company       String?
  
  type          String   @default("buyer")
  status        String   @default("active")
  
  budget        Decimal?  @db.Decimal(15, 2)
  cashAvailable Decimal?  @db.Decimal(15, 2)
  creditScore   Int?
  preQualified  Boolean   @default(false)
  
  industries    String[]
  locations     String[]
  notes         String?   @db.Text
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  deals         Deal[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@map("clients")
}

// =============================================================================
// DEAL MANAGEMENT
// =============================================================================

model Deal {
  id              String   @id @default(cuid())
  name            String
  
  status          String   @default("active")
  stage           String   @default("analysis")
  priority        String   @default("medium")
  
  businessType    String?
  industry        String?
  businessName    String?
  location        String?
  yearEstablished Int?
  employees       Int?
  
  askingPrice     Decimal?  @db.Decimal(15, 2)
  annualRevenue   Decimal?  @db.Decimal(15, 2)
  annualSDE       Decimal?  @db.Decimal(15, 2)
  annualEBITDA    Decimal?  @db.Decimal(15, 2)
  
  downPayment     Decimal?  @db.Decimal(15, 2)
  sellerFinancing Decimal?  @db.Decimal(15, 2)
  
  listingUrl      String?
  listingSource   String?
  listingId       String?
  
  notes           String?   @db.Text
  tags            String[]
  
  visibility      String    @default("private")
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  clientId        String?
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  
  analyses        Analysis[]
  scenarios       Scenario[]
  documents       Document[]
  exports         Export[]
  activities      Activity[]
  
  closedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([businessType])
  @@map("deals")
}

// =============================================================================
// ANALYSIS & CALCULATIONS
// =============================================================================

model Analysis {
  id        String   @id @default(cuid())
  dealId    String
  
  type      String
  name      String
  version   Int      @default(1)
  
  inputs    Json
  outputs   Json
  metadata  Json?
  
  status    String   @default("draft")
  isLatest  Boolean  @default(true)
  
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  scenarios Scenario[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([type])
  @@map("analyses")
}

model Scenario {
  id          String   @id @default(cuid())
  
  name        String
  description String?
  type        String   @default("custom")
  
  inputs      Json
  outputs     Json
  
  comparedTo  String?
  
  analysisId  String?
  analysis    Analysis? @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  dealId      String?
  deal        Deal?     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([analysisId])
  @@index([dealId])
  @@map("scenarios")
}

// =============================================================================
// DOCUMENT MANAGEMENT
// =============================================================================

model Document {
  id          String   @id @default(cuid())
  
  name        String
  type        String
  mimeType    String
  size        Int
  url         String
  
  description String?
  year        Int?
  
  dealId      String
  deal        Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  uploadedBy  String
  
  createdAt   DateTime @default(now())

  @@index([dealId])
  @@map("documents")
}

// =============================================================================
// EXPORTS & REPORTS
// =============================================================================

model Export {
  id          String   @id @default(cuid())
  
  format      String
  type        String
  name        String
  
  config      Json?
  
  branded     Boolean  @default(false)
  
  status      String   @default("pending")
  url         String?
  error       String?
  expiresAt   DateTime?
  
  dealId      String?
  deal        Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([dealId])
  @@map("exports")
}

// =============================================================================
// ACTIVITY & AUDIT LOG
// =============================================================================

model Activity {
  id          String   @id @default(cuid())
  
  action      String
  resource    String
  resourceId  String
  
  description String?
  metadata    Json?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dealId      String?
  deal        Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([dealId])
  @@index([resource, resourceId])
  @@map("activities")
}

// =============================================================================
// USAGE TRACKING
// =============================================================================

model UsageRecord {
  id          String   @id @default(cuid())
  
  resource    String
  count       Int      @default(0)
  
  period      String
  periodStart DateTime
  periodEnd   DateTime
  
  userId      String?
  organizationId String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([resource, period, periodStart, userId])
  @@unique([resource, period, periodStart, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("usage_records")
}

// =============================================================================
// FEATURE FLAGS
// =============================================================================

model FeatureFlag {
  id          String   @id @default(cuid())
  
  name        String   @unique
  description String?
  
  enabled     Boolean  @default(false)
  minPlan     String?
  
  allowedUsers String[]
  allowedOrgs  String[]
  
  rolloutPercentage Int @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("feature_flags")
}

// =============================================================================
// LEAD CAPTURE
// =============================================================================

model Lead {
  id          String   @id @default(cuid())
  
  email       String
  name        String?
  phone       String?
  company     String?
  
  source      String
  sourceUrl   String?
  
  calculatorType  String?
  calculatorData  Json?
  
  interestedIn    String[]
  loanAmount      Decimal? @db.Decimal(15, 2)
  
  status      String   @default("new")
  notes       String?  @db.Text
  
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  
  convertedToUserId String?
  convertedAt       DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([source])
  @@map("leads")
}

// =============================================================================
// INDUSTRY BENCHMARKS
// =============================================================================

model IndustryBenchmark {
  id          String   @id @default(cuid())
  
  industry    String
  subIndustry String?
  
  sdeMultipleLow    Decimal @db.Decimal(4, 2)
  sdeMultipleMid    Decimal @db.Decimal(4, 2)
  sdeMultipleHigh   Decimal @db.Decimal(4, 2)
  
  ebitdaMultipleLow  Decimal @db.Decimal(4, 2)
  ebitdaMultipleMid  Decimal @db.Decimal(4, 2)
  ebitdaMultipleHigh Decimal @db.Decimal(4, 2)
  
  revenueMultipleLow  Decimal @db.Decimal(4, 2)
  revenueMultipleMid  Decimal @db.Decimal(4, 2)
  revenueMultipleHigh Decimal @db.Decimal(4, 2)
  
  sizeRange   String?
  region      String?
  source      String?
  year        Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([industry, subIndustry, sizeRange, region, year])
  @@index([industry])
  @@map("industry_benchmarks")
}